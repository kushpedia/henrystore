

{% extends 'partials/base.html' %}
{% load humanize %}
{% load static %}
{% block content %}
<style>
    .bg-light-success {
        background-color: #f0fff4;
        border-color: #28a745 !important;
    }
    .bg-light-danger {
        background-color: #fff5f5;
        border-color: #dc3545 !important;
    }
    .badge {
        font-weight: 500;
        border-radius: 50px;
    }
    .border {
        transition: all 0.3s ease;
    }
    .border:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
</style>
<main class="main pages">
	<div class="page-header breadcrumb-wrap">
		<div class="container">
			<div class="breadcrumb">
				<a href="{% url 'core:index' %}" rel="nofollow"><i class="fi-rs-home mr-5"></i>Home</a>
				<span></span> Pages <span></span> Dashboard
			</div>
		</div>
	</div>
	<div class="page-content pt-150 pb-150">
		<div class="container">
			<div class="row">
				<div class="col-lg-10 m-auto">
					<div class="row">
						<div class="col-md-3">
							<div class="dashboard-menu">
								<ul class="nav flex-column" role="tablist">
									<li class="nav-item">
										<a class="nav-link active" id="profile-tab" data-bs-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false"><i class="fi-rs-user mr-10"></i>Profile</a>
									</li>
									<li class="nav-item">
										<a class="nav-link" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false"><i class="fi-rs-settings-sliders mr-10"></i>Dashboard</a>
									</li>
									<li class="nav-item">
										<a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false"><i class="fi-rs-shopping-bag mr-10"></i>Orders</a>
									</li>
									<li class="nav-item">
										<a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false"><i class="fi-rs-shopping-cart-check mr-10"></i>Returns</a>
									</li>
									<li class="nav-item">
										<a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="true"><i class="fi-rs-marker mr-10"></i>My Address</a>
									</li>
									<li class="nav-item">
										<a class="nav-link" id="account-detail-tab" data-bs-toggle="tab" href="#account-detail" role="tab" aria-controls="account-detail" aria-selected="true"><i class="fi-rs-user mr-10"></i>Account details</a>
									</li>
									<li class="nav-item">
										<a class="nav-link" href="{% url 'userauths:sign-out' %}"><i class="fi-rs-sign-out mr-10"></i>Logout</a>
									</li>
								</ul>
							</div>
						</div>
						<div class="col-md-9">
							<div class="tab-content account dashboard-content pl-50">
								<div class="tab-pane fade active show" id="profile" role="tabpanel" aria-labelledby="profile-tab">
									<div class="card">
										<div class="card-header border-bottom">
											<h3 class="mb-0">My Profile</h3>
										</div>
										<div class="card-body mb-2" style="display: flex; align-items: center; gap: 10px;">
											<div>
												{% if user_profile.image %}
												<span><img src="{{ user_profile.image.url }}" style="width: 150px; object-fit: cover; border-radius:50%; height:150px;" alt=""></span>
												{% else %}
												<span><img src="https://t4.ftcdn.net/jpg/00/64/67/63/360_F_64676383_LdbmhiNM6Ypzb3FM4PPuFP9rHe7ri8Ju.jpg" style="width: 150px; object-fit: cover; border-radius:50%; height:150px;" alt=""></span>

												{% endif %}
											</div>

											<div>
												<span><input class="mb-2" type="text" value="Name - {{ user_profile.full_name }}"></span>
												<span><input class="mb-2" type="text" value="Bio - {{ user_profile.bio }}"></span>
												<span><input class="mb-2" type="text" value="Phone - {{ user_profile.phone }}"></span>
												{% if user_profile.verified == True %}
												<div class="p-4 border rounded">
													<span>Verified</span> <span> <i class="fas fa-check-circle"></i> </span>
												</div>
												{% else %}
												<div class="p-4 border rounded">
													<span>Not verified </span> <span> <i class="fas fa-x"></i> </span>
												</div>
												{% endif %}
												<div class="p-4 border rounded">
												<a href="{% url 'userauths:profile-update' %}" class="btn btn-succees">Edit Profile</a>
												</div>
											</div>
										</div>

									</div>
								</div>
								<div class="tab-pane fade" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
									<div class="card">
										<div class="card-header">
											<h3 class="mb-0">Hello {{request.user|title}}!</h3>
										</div>
										<div class="card-body">
											<p>
												From your account dashboard. you can easily check &amp; view your <a href="#">recent orders</a>,<br />
												manage your <a href="#">shipping and billing addresses</a> and <a href="#">edit your password and account details.</a>
											</p>
										</div>
										<!-- <div class="mt-4">
											<p>{{ month }}</p>
											<p>{{ total_orders }}</p>
										</div> -->
										<div style="height: 800px; width: 800px; object-fit: cover;">
											<canvas id="myChart"></canvas>
										</div>
									</div>
								</div>
								<div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
									<div class="card">
										<div class="card-header">
											<h3 class="mb-0">Your Orders</h3>
										</div>
										<div class="card-body">
											<div class="table-responsive">
												<table class="table">
													<thead>
														<tr>
															<th>Order</th>
															<th>Date</th>
															<th>Status</th>
															<th>Paid Status</th>
															<th>Total</th>
															<th>Actions</th>
														</tr>
													</thead>
													<tbody>
														{% for o in orders_list %}
														<tr>
															<td>INVOICE_NO-{{o.id}}</td>

															<td>{{o.order_date}}</td>
															<td>{{o.product_status|title}}</td>
															{% if o.paid_status == True %}
															<td class="text-success"><b>âœ“</b></td>
															{% else %}
															<td class="text-danger"><b><span>X</span></b></td>

															{% endif %}
															<td>Ksh {{o.price|floatformat:2|intcomma}}</td>
															<td><a href="{% url 'core:order-detail' o.id %}" class="btn-small d-block">View</a></td>
														</tr>
														{% endfor %}
													</tbody>
												</table>
											</div>
										</div>
									</div>
								</div>
								<div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
									<div class="card border-0 shadow-sm">
										<div class="card-header bg-white py-3">
											<h3 class="mb-0">
												<i class="fi-rs-return me-2 text-primary"></i>
												My Returns
											</h3>
										</div>
										
										{% if returns %}
										<div class="card-body">
											<p class="text-muted mb-4">Track and manage your return requests</p>
											
											{% for return in returns %}
											<div class="border rounded-3 p-4 mb-3 {% if return.status == 'completed' %}bg-light-success{% elif return.status == 'rejected' %}bg-light-danger{% endif %}">
												<!-- Return Header -->
												<div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
													<div>
														<h5 class="mb-1">
															Return #{{ return.rma_number }}
															<small class="text-muted ms-2">(Order #{{ return.order.oid }})</small>
														</h5>
														<p class="small text-muted mb-0">
															<i class="fi-rs-calendar me-1"></i> Requested: {{ return.created_at|date:"F j, Y" }}
														</p>
													</div>
													<div>
														{% if return.status == 'pending' %}
															<span class="badge bg-warning text-dark px-3 py-2">Pending Approval</span>
														{% elif return.status == 'approved' %}
															<span class="badge bg-info text-white px-3 py-2">Approved - Awaiting Shipment</span>
														{% elif return.status == 'received' %}
															<span class="badge bg-primary text-white px-3 py-2">Item Received</span>
														{% elif return.status == 'completed' %}
															<span class="badge bg-success text-white px-3 py-2">Refund Completed</span>
														{% elif return.status == 'rejected' %}
															<span class="badge bg-danger text-white px-3 py-2">Rejected</span>
														{% endif %}
													</div>
												</div>
												
												<!-- Item Details -->
												<div class="row g-3 mb-3">
													<div class="col-md-6">
														<div class="d-flex align-items-center">
															<div class="flex-shrink-0 me-3">
																<img src="{{ return.order_item.image }}" 
																		alt="{{ return.order_item.item }}" 
																		style="width: 60px; height: 60px; object-fit: cover;" 
																		class="rounded border">
															</div>
															<div class="flex-grow-1">
																<h6 class="mb-1">{{ return.order_item.item }}</h6>
																<div class="small text-muted">
																	{% if return.order_item.size %}Size: {{ return.order_item.size }}{% endif %}
																	{% if return.order_item.size and return.order_item.color %} | {% endif %}
																	{% if return.order_item.color %}Color: {{ return.order_item.color }}{% endif %}
																</div>
															</div>
														</div>
													</div>
													
													<div class="col-md-3">
														<div class="small text-muted">Quantity</div>
														<div class="fw-medium">{{ return.quantity }} of {{ return.order_item.qty }}</div>
													</div>
													
													<div class="col-md-3">
														<div class="small text-muted">Refund Amount</div>
														<div class="fw-medium text-success">{{ return.refund_amount|floatformat:0|intcomma }}</div>
													</div>
												</div>
												
												<!-- Reason & Actions -->
												<div class="d-flex flex-wrap align-items-center justify-content-between pt-2 border-top">
													<div class="small">
														<span class="text-muted">Reason:</span>
														<span class="fw-medium ms-1">{{ return.reason|truncatechars:50 }}</span>
													</div>
													
													<div class="d-flex gap-2 mt-2 mt-sm-0">
														<a href="{% url 'core:return-status' return.rma_number %}" 
															class="btn btn-sm btn-outline-primary">
															<i class="fi-rs-eye me-1"></i>View Details
														</a>
														
														{% if return.status == 'approved' and not return.tracking_number %}
														<button type="button" 
																class="btn btn-sm btn-outline-info" 
																data-bs-toggle="modal" 
																data-bs-target="#trackingModal{{ return.id }}">
															<i class="fi-rs-truck me-1"></i>Add Tracking
														</button>
														
														<!-- Tracking Modal -->
														<div class="modal fade" id="trackingModal{{ return.id }}" tabindex="-1">
															<div class="modal-dialog">
																<div class="modal-content">
																	<div class="modal-header">
																		<h5 class="modal-title">Add Tracking Information</h5>
																		<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
																	</div>
																	<form method="post" action="{% url 'core:add-return-tracking' return.id %}">
																		{% csrf_token %}
																		<div class="modal-body">
																			<p class="small text-muted mb-3">
																				Please enter the tracking number from your return shipment.
																			</p>
																			<div class="mb-3">
																				<label class="form-label">Shipping Carrier</label>
																				<select name="shipping_carrier" class="form-select" required>
																					<option value="">Select carrier...</option>
																					<option value="Wells Fargo">Well Fago</option>
																					<option value="G4S">G4S</option>
																					<option value="Mololine">Mololine</option>
																					<option value="Tahmid">Tahmid</option>
																					<option value="Lopha">Lopha</option>
																				</select>
																			</div>
																			<div class="mb-3">
																				<label class="form-label">Tracking Number</label>
																				<input type="text" name="tracking_number" class="form-control" 
																					placeholder="Enter tracking number" required>
																			</div>
																		</div>
																		<div class="modal-footer">
																			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
																			<button type="submit" class="btn btn-primary">Submit Tracking</button>
																		</div>
																	</form>
																</div>
															</div>
														</div>
														{% endif %}
														
														{% if return.tracking_number %}
														<span class="btn btn-sm btn-outline-success" title="Tracking: {{ return.tracking_number }}">
															<i class="fi-rs-check me-1"></i>Shipped
														</span>
														{% endif %}
													</div>
												</div>
											</div>
											{% endfor %}
										</div>
										
										<!-- Pagination (if needed) -->
										{% if returns.has_other_pages %}
										<div class="card-footer bg-white border-0">
											<nav aria-label="Returns pagination">
												<ul class="pagination justify-content-center mb-0">
													{% if returns.has_previous %}
													<li class="page-item">
														<a class="page-link" href="?page={{ returns.previous_page_number }}#track-orders">Previous</a>
													</li>
													{% endif %}
													
													{% for num in returns.paginator.page_range %}
													<li class="page-item {% if returns.number == num %}active{% endif %}">
														<a class="page-link" href="?page={{ num }}#track-orders">{{ num }}</a>
													</li>
													{% endfor %}
													
													{% if returns.has_next %}
													<li class="page-item">
														<a class="page-link" href="?page={{ returns.next_page_number }}#track-orders">Next</a>
													</li>
													{% endif %}
												</ul>
											</nav>
										</div>
										{% endif %}
										
										{% else %}
										<div class="card-body text-center py-5">
											<div class="mb-4">
												<i class="fi-rs-return" style="font-size: 64px; color: #dee2e6;"></i>
											</div>
											<h5 class="text-muted mb-3">No Return Requests Found</h5>
											<p class="text-muted mb-4">You haven't submitted any return requests yet.</p>
											<a href="{% url 'core:orders' %}" class="btn btn-primary">
												<i class="fi-rs-shopping-cart me-2"></i>View Your Orders
											</a>
										</div>
										{% endif %}
									</div>
								</div>
								<div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
									<div class="row">
											<div>
												<form class="mb-4" method="POST" > {% csrf_token %}
													<div class="card-hdeader">
														<h5>Add Address</h5>
													</div>
													<div class="row">
														<div class="form-group col-md-6">
															<input placeholder="Address" required="" class="form-control" name="address" type="text" />
														</div>
														<div class="form-group col-md-6">
															<input placeholder="Phone" required="" class="form-control" name="mobile" />
														</div>
														<div class="col-md-12">
															<button type="submit" class="btn btn-fill-out submit font-weight-bold" name="submit" value="Submit">Save Address</button>
														</div>
													</div>
												</form>
											</div>
											<hr>
											<br>
											{% for a in addresses %}
										<div class="col-lg-6">
											<div class="card mb-3 mb-lg-0">

												<div class="card-header">
													<h4 class="mb-0">Address {{ forloop.counter }}</h4>
												</div>




												<div class="card-body border rounded ">
													<address>
														<p>{{ a.address }}</p>
														<p>{{ a.mobile }}</p>
														<!-- <p>{{ a.id }}</p> -->
														<!-- <p>{{ a.status }}</p> -->

													</address>
													<br>
													{% if a.status %}
														<i data-address-id="{{ a.id }}" class="fa fa-check-circle text-success check{{ a.id }} check"></i>
														<button data-address-id="{{ a.id }}"  style="display: none;" class="btn make-default-address button{{ a.id }} action_btn">Make Default</button>

													{% else %}
														<i data-address-id="{{ a.id }}" style="display: none;" class="fa fa-check-circle text-success check check{{ a.id }}"></i>
														<button data-address-id="{{ a.id }}"   class="btn make-default-address button{{ a.id }} action_btn">Make Default</button>
													{% endif %}

												</div>

											</div>
										</div>
										{% endfor %}

									</div>
								</div>
								<div class="tab-pane fade" id="account-detail" role="tabpanel" aria-labelledby="account-detail-tab">
									<div class="card">
										<div class="card-header">
											<h5>Account Details</h5>
										</div>
										<div class="card-body">
											<p>Already have an account? <a href="page-login.html">Log in instead!</a></p>
											<form method="post" name="enq">
												<div class="row">
													<div class="form-group col-md-6">
														<label>First Name <span class="required">*</span></label>
														<input required="" class="form-control" name="name" type="text" />
													</div>
													<div class="form-group col-md-6">
														<label>Last Name <span class="required">*</span></label>
														<input required="" class="form-control" name="phone" />
													</div>
													<div class="form-group col-md-12">
														<label>Display Name <span class="required">*</span></label>
														<input required="" class="form-control" name="dname" type="text" />
													</div>
													<div class="form-group col-md-12">
														<label>Email Address <span class="required">*</span></label>
														<input required="" class="form-control" name="email" type="email" />
													</div>
													<div class="form-group col-md-12">
														<label>Current Password <span class="required">*</span></label>
														<input required="" class="form-control" name="password" type="password" />
													</div>
													<div class="form-group col-md-12">
														<label>New Password <span class="required">*</span></label>
														<input required="" class="form-control" name="npassword" type="password" />
													</div>
													<div class="form-group col-md-12">
														<label>Confirm Password <span class="required">*</span></label>
														<input required="" class="form-control" name="cpassword" type="password" />
													</div>
													<div class="col-md-12">
														<button type="submit" class="btn btn-fill-out submit font-weight-bold" name="submit" value="Submit">Save Change</button>
													</div>
												</div>
											</form>
										</div>
									</div>
								</div>
							</div>
						</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</main>
<script>
	const labels = {{ month|safe }}

	const data = {
		labels: labels,
		datasets: [{
		label: 'Orders',
		backgroundColor: 'rgb(59, 183, 126)',
		borderColor: 'rgb(59, 183, 126)',
		data: {{ total_orders|safe }}
		}],

	};

	const config = {
		type: 'bar',
		data: data,
		options: {
		tooltips: {enabled: false},
		hover: {mode: null},
		}
	};

	const myChart = new Chart(
		document.getElementById('myChart'),
		config
	);
	</script>





{% endblock content %}