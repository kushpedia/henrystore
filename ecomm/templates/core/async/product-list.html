<!-- core/async/product-list.html -->
{% load humanize %}

{% if products %}
    {% for p in products %}
    <div class="col-lg-1-5 col-md-4 col-6 col-sm-6 product-item" data-product-id="{{ p.id }}">
        <div class="product-cart-wrap mb-30">
            <div class="product-img-action-wrap">
                <div class="product-img product-img-zoom">
                    <a href="{% url 'core:product-detail' p.pid %}">
                        <img class="default-img" src="{{ p.image.url }}" alt="{{ p.title }}" />
                        <img class="hover-img" src="{{ p.image.url }}" alt="{{ p.title }}" />
                    </a>
                </div>
                <div class="product-action-1">
                    <button style="border: none;" class="add-to-wishlist" data-product-item="{{ p.id }}">
                        <i class="fi-rs-heart" style="fill: aqua;"></i>
                    </button>
                    <a aria-label="Quick view"
						class="action-btn quick-view-btn"
						data-bs-toggle="modal"
						data-bs-target="#quickViewModal"
						data-id="{{ p.id }}"
						data-title="{{ p.title }}"
						data-price="{{ p.price }}"
						data-oldprice="{{ p.old_price }}"
						data-image="{{ p.image.url }}"
						data-description="{{ p.description }}"
						data-vendor="{{ p.vendor.title }}"
						data-percentage="{{ p.get_precentage }}"
						data-pid="{{ p.pid }}">
                        <i class="fi-rs-eye"></i>
                    </a>
                </div>
                {% if p.get_precentage > 0 %}
                <div class="product-badges product-badges-position product-badges-mrg">
                    <span class="hot">-{{ p.get_precentage|floatformat:0 }} %</span>
                </div>
                {% endif %}
            </div>
            <div class="product-content-wrap">
                <div class="product-category">
                    <a href="{% url 'core:category-product-list' p.mini_subcategory.subcategory.category.cid %}">
                        {{ p.mini_subcategory.subcategory.category.title }}
                    </a>
                </div>
                <h2><a href="{% url 'core:product-detail' p.pid %}">{{ p.title|truncatechars:30 }}</a></h2>
                
                <!-- <div>
                    <span class="font-small text-muted">By <a href="{% url 'core:vendor-detail' p.vendor.vid %}">{{ p.vendor }}</a></span>
                </div> -->
                <div class="product-card-bottom">
                    <div class="product-price">
                        <span>Ksh </span>
                        <span class="current-product-price-{{ p.id }}">{{ p.price|intcomma }}</span>
                        {% if p.old_price %}
                        <span class="old-price">{{ p.old_price|floatformat:0|intcomma }}Ksh</span>
                        {% endif %}
                    </div>
                    
                    
                    
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- Empty state for no products -->
    {% else %}
    <div class="col-12">
        <div class="card text-center p-5">
            <div class="card-body">
                <i class="fi-rs-search text-muted mb-3" style="font-size: 48px;"></i>
                <h4 class="text-muted">No products found</h4>
                <p class="text-muted">Try adjusting your filters to find more products.</p>
                {% if request.GET.min_price or request.GET.max_price or request.GET.category or request.GET.vendor %}
                <button class="btn btn-sm btn-primary mt-2" onclick="clearFilters()">
                    <i class="fi-rs-filter mr-2"></i>Clear Filters
                </button>
                {% endif %}
            </div>
        </div>
    </div>
{% endif %}

<!-- JavaScript for new product cards -->
<script>
    // Re-initialize event handlers for newly loaded products
    $(document).ready(function() {
        // Initialize wishlist buttons for new products
        $('.product-item .add-to-wishlist').off('click').on('click', function() {
            const productId = $(this).data('product-item');
            addToWishlist(productId);
        });
        
        // Initialize quick view for new products
        $('.product-item .quick-view-btn').off('click').on('click', function() {
            const productData = {
                id: $(this).data('id'),
                title: $(this).data('title'),
                price: $(this).data('price'),
                oldprice: $(this).data('oldprice'),
                image: $(this).data('image'),
                description: $(this).data('description'),
                vendor: $(this).data('vendor'),
                percentage: $(this).data('percentage'),
                pid: $(this).data('pid')
            };
            openQuickView(productData);
        });
        
        // Initialize add to cart buttons for new products
        $('.product-item .add-to-cart-btn').off('click').on('click', function() {
            const productId = $(this).data('index');
            addToCart(productId);
        });
    });
    
    // Animation for new products
    $('.product-item').hide().fadeIn(500);
</script>